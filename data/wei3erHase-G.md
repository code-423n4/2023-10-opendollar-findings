`lastSurplusTime` can be set twice on a single transaction, consider moving it out of the `if{}elseif{}` scope.